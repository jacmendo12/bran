<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estrategia Bran V1 - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            background-color: #0f1419;
            color: #e1e8ed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card {
            background-color: #192734;
            border: 1px solid #38444d;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            background-color: #253341;
            border-bottom: 1px solid #38444d;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1da1f2;
        }
        
        .stat-label {
            color: #8899a6;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .positive {
            color: #17c671 !important;
        }
        
        .negative {
            color: #f45d48 !important;
        }
        
        .controls {
            background-color: #192734;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .form-select, .form-control {
            background-color: #253341;
            border-color: #38444d;
            color: #e1e8ed;
        }
        
        .form-select:focus, .form-control:focus {
            background-color: #253341;
            border-color: #1da1f2;
            color: #e1e8ed;
            box-shadow: 0 0 0 0.25rem rgba(29, 161, 242, 0.25);
        }
        
        .btn-primary {
            background-color: #1da1f2;
            border-color: #1da1f2;
        }
        
        .btn-primary:hover {
            background-color: #1a91da;
            border-color: #1a91da;
        }
        
        #loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            color: #1da1f2;
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4 py-4">
        <div class="dashboard-header">
            <h1 class="mb-2">üìä Estrategia Bran V1 - GC=F</h1>
        </div>
        
        <div class="controls">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label for="assetSelect" class="form-label">Activo</label>
                    <input type="text" class="form-control" id="assetSelect" value="GC=F" placeholder="Ej: GC=F, EURUSD=X, MSFT, AAPL">
                </div>
                <div class="col-md-2">
                    <label for="intervalSelect" class="form-label">Intervalo</label>
                    <select class="form-select" id="intervalSelect">
                        <option value="1m">1 Minuto</option>
                        <option value="5m">5 Minutos</option>
                        <option value="15m">15 Minutos</option>
                        <option value="1h" selected>1 Hora</option>
                        <option value="4h">4 Horas</option>
                        <option value="1d">1 D√≠a</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">Fecha de Inicio (1000 velas)</label>
                    <input type="datetime-local" class="form-control" id="startDate">
                </div>
                <div class="col-md-2">
                    <label for="minimumTresure" class="form-label">Minimum Tresure</label>
                    <input type="number" class="form-control" id="minimumTresure" value="2.1" step="0.1" min="0">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadData()">
                        üîÑ Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
        
        <div id="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando datos del mercado...</p>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        üìà Gr√°fico de Velas (Candlestick)
                    </div>
                    <div class="card-body">
                        <div id="candlestickChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="statistics" class="row mb-4">
            <!-- Las estad√≠sticas se cargar√°n din√°micamente aqu√≠ -->
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        üìä An√°lisis de Volumen
                    </div>
                    <div class="card-body">
                        <div id="volumeChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar fecha por defecto
        function initializeDates() {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7); // 7 d√≠as atr√°s por defecto
            
            document.getElementById('startDate').value = formatDateForInput(startDate);
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        async function loadData() {
            const asset = document.getElementById('assetSelect').value;
            const interval = document.getElementById('intervalSelect').value;
            const startDateStr = document.getElementById('startDate').value;
            const minimumTresure = document.getElementById('minimumTresure').value;
            
            if (!startDateStr) {
                alert('Por favor, selecciona la fecha de inicio');
                return;
            }
            
            const startTime = new Date(startDateStr).getTime();
            
            // Usar l√≠mite fijo de 1000 velas (m√°ximo permitido por Binance)
            const limit = 1000;
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch(`/api/estrategia-bran-v1/data?asset=${asset}&interval=${interval}&limit=${limit}&start_time=${startTime}&minimum_tresure=${minimumTresure}`);
                const result = await response.json();
                
                // Console log del resultado de detect_pullbacks
                console.log('=== Resultado de detect_pullbacks ===');
                console.log('Rangos:', result.rangos);
                console.log('Total de velas:', result.total_candles);
                console.log('Datos completos:', result);
                console.log('====================================');
                
                if (result.success) {
                    renderStatistics(result.statistics);
                    renderCharts(result.data, result.rangos);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error al cargar datos: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function renderStatistics(stats) {
            const priceChangeClass = stats.price_change >= 0 ? 'positive' : 'negative';
            const priceChangeSymbol = stats.price_change >= 0 ? '‚ñ≤' : '‚ñº';
            
            const html = `
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">$${stats.current_price.toFixed(2)}</div>
                        <div class="stat-label">Precio Actual</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value ${priceChangeClass}">
                            ${priceChangeSymbol} ${stats.price_change_percentage.toFixed(2)}%
                        </div>
                        <div class="stat-label">Cambio de Precio</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">${stats.total_volume.toFixed(2)}</div>
                        <div class="stat-label">Volumen Total</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">${stats.average_volume.toFixed(2)}</div>
                        <div class="stat-label">Volumen Promedio</div>
                    </div>
                </div>
            `;
            
            document.getElementById('statistics').innerHTML = html;
        }
        
        function renderCharts(data, rangos) {
            // Preparar datos
            const times = data.map(d => d.time);
            const opens = data.map(d => d.open);
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            const closes = data.map(d => d.close);
            const volumes = data.map(d => d.volume);
            
            // Extraer datos de pullbacks
            const altos = data.map(d => d.altos);
            const bajos = data.map(d => d.bajos);
            const pocAltos = data.map(d => d.pocAltos);
            const pocBajos = data.map(d => d.pocBajos);
            
            // Extraer datos de pivots locales (TODOS los pivots)
            const pivotAlto = data.map(d => d.pivotAlto);
            const pivotBajo = data.map(d => d.pivotBajo);
            
            // Gr√°fico de velas
            const candlestickTrace = {
                x: times,
                close: closes,
                high: highs,
                low: lows,
                open: opens,
                type: 'candlestick',
                name: 'Precio',
                increasing: {line: {color: '#17c671'}},
                decreasing: {line: {color: '#f45d48'}}
            };
            
            // Marcadores de altos (Y hacia arriba)
            const altosTrace = {
                x: times,
                y: altos,
                mode: 'markers',
                marker: {
                    color: 'rgb(255, 255, 255)',
                    size: 7,
                    symbol: 'y-up-open'
                },
                name: 'Altos'
            };
            
            // Marcadores de bajos (Y hacia abajo)
            const bajosTrace = {
                x: times,
                y: bajos,
                mode: 'markers',
                marker: {
                    color: 'rgb(255, 255, 255)',
                    size: 7,
                    symbol: 'y-down-open'
                },
                name: 'Bajos'
            };
            
            // Marcadores de POC Altos (tri√°ngulos peque√±os hacia arriba en blanco)
            const pocAltosTrace = {
                x: times,
                y: pocAltos,
                mode: 'markers',
                marker: {
                    color: 'rgb(255, 255, 255)',
                    size: 5,
                    symbol: 'triangle-up-open'
                },
                name: 'POC Altos'
            };
            
            // Marcadores de POC Bajos (tri√°ngulos peque√±os hacia abajo en blanco)
            const pocBajosTrace = {
                x: times,
                y: pocBajos,
                mode: 'markers',
                marker: {
                    color: 'rgb(255, 255, 255)',
                    size: 5,
                    symbol: 'triangle-down-open'
                },
                name: 'POC Bajos'
            };
            
            // Marcadores de Pivots Altos Locales (c√≠rculos peque√±os en cyan/azul claro)
            const pivotAltoTrace = {
                x: times,
                y: pivotAlto,
                mode: 'markers',
                marker: {
                    color: 'rgb(0, 255, 255)',  // Cyan
                    size: 4,
                    symbol: 'circle'
                },
                name: 'Pivot Alto'
            };
            
            // Marcadores de Pivots Bajos Locales (c√≠rculos peque√±os en magenta)
            const pivotBajoTrace = {
                x: times,
                y: pivotBajo,
                mode: 'markers',
                marker: {
                    color: 'rgb(255, 0, 255)',  // Magenta
                    size: 4,
                    symbol: 'circle'
                },
                name: 'Pivot Bajo'
            };
            
            // Determinar colores de las l√≠neas seg√∫n tendencia
            const rangoAltoColor = rangos.tendencia === 1 ? 'green' : '#ff9900';
            const rangoBajoColor = rangos.tendencia === 1 ? '#ff9900' : 'green';
            
            const candlestickLayout = {
                paper_bgcolor: '#192734',
                plot_bgcolor: '#192734',
                font: {color: '#e1e8ed'},
                xaxis: {
                    gridcolor: '#38444d',
                    rangeslider: {visible: false}
                },
                yaxis: {
                    gridcolor: '#38444d'
                },
                shapes: [
                    // L√≠nea de rango alto
                    {
                        type: 'line',
                        x0: times[0],
                        x1: times[times.length - 1],
                        y0: rangos.rangoAlto,
                        y1: rangos.rangoAlto,
                        line: {
                            color: rangoAltoColor,
                            width: 2,
                            dash: 'dash'
                        }
                    },
                    // L√≠nea de rango bajo
                    {
                        type: 'line',
                        x0: times[0],
                        x1: times[times.length - 1],
                        y0: rangos.rangoBajo,
                        y1: rangos.rangoBajo,
                        line: {
                            color: rangoBajoColor,
                            width: 2,
                            dash: 'dash'
                        }
                    }
                ],
                annotations: [
                    {
                        text: `Tendencia: ${rangos.tendencia === 1 ? 'Alcista ‚ñ≤' : rangos.tendencia === -1 ? 'Bajista ‚ñº' : 'Neutral ‚îÅ'}`,
                        xref: 'paper',
                        yref: 'paper',
                        x: 0,
                        y: 1.05,
                        showarrow: false,
                        font: {size: 14, color: rangos.tendencia === 1 ? '#17c671' : rangos.tendencia === -1 ? '#f45d48' : '#1da1f2'}
                    }
                ],
                margin: {t: 40, b: 40, l: 60, r: 40}
            };
            
            // Agregar todas las trazas al gr√°fico
            const traces = [candlestickTrace, pivotAltoTrace, pivotBajoTrace, altosTrace, bajosTrace, pocAltosTrace, pocBajosTrace];
            
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, {responsive: true});
            
            // Gr√°fico de volumen
            const volumeTrace = {
                x: times,
                y: volumes,
                type: 'bar',
                name: 'Volumen',
                marker: {color: '#1da1f2', opacity: 0.7}
            };
            
            const volumeLayout = {
                paper_bgcolor: '#192734',
                plot_bgcolor: '#192734',
                font: {color: '#e1e8ed'},
                xaxis: {gridcolor: '#38444d'},
                yaxis: {gridcolor: '#38444d'},
                margin: {t: 20, b: 40, l: 60, r: 40}
            };
            
            Plotly.newPlot('volumeChart', [volumeTrace], volumeLayout, {responsive: true});
        }
        
        // Cargar datos iniciales al cargar la p√°gina
        window.onload = function() {
            initializeDates();
            loadData();
        };
    </script>
</body>
</html>
